# CLOUD RUN SETUP REQUIREMENTS

## ‚ö†Ô∏è CRITICAL: MANUAL SETUP REQUIRED BEFORE DEPLOYMENT

### 1. SECRET MANAGER SECRET (REQUIRED)

**Secret Name:** `google-ai-api-key`

**Why:** All agent services (summarizer, explainer, critic, visualizer) require this secret to access the Gemini API.

**Create Command:**
```bash
echo -n "YOUR_GEMINI_API_KEY" | gcloud secrets create google-ai-api-key \
  --data-file=- \
  --replication-policy="automatic"
```

**Verify:**
```bash
gcloud secrets list --filter="name:google-ai-api-key"
```

**Grant Access to Cloud Run Services:**
```bash
# Grant access to all agent services
gcloud secrets add-iam-policy-binding google-ai-api-key \
  --member="serviceAccount:PROJECT_NUMBER-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

### 2. CLOUD STORAGE BUCKET (REQUIRED)

**Bucket Name:** `explainiq-diagrams` (or as configured in `GCS_BUCKET` environment variable)

**Why:** Used for storing diagram images generated by the visualizer agent.

**Create Command:**
```bash
gsutil mb -p PROJECT_ID -l REGION gs://explainiq-diagrams
```

**Set CORS (if needed for frontend access):**
```bash
gsutil cors set cors.json gs://explainiq-diagrams
```

**Verify:**
```bash
gsutil ls -p PROJECT_ID
```

---

## ‚úÖ AUTOMATICALLY HANDLED BY DEPLOYMENT SCRIPT

### 3. APIs (AUTOMATICALLY ENABLED)

The deployment script automatically enables:
- `run.googleapis.com` - Cloud Run API
- `cloudbuild.googleapis.com` - Cloud Build API
- `artifactregistry.googleapis.com` - Artifact Registry API
- `secretmanager.googleapis.com` - Secret Manager API
- `storage.googleapis.com` - Cloud Storage API

### 4. ARTIFACT REGISTRY (AUTOMATICALLY CREATED)

**Repository:** `explainiq-repo`
**Location:** `europe-west1` (or your specified region)
**Format:** Docker

The deployment script automatically creates this if it doesn't exist.

### 5. SERVICE ACCOUNTS AND IAM (AUTOMATICALLY CONFIGURED)

The deployment script automatically:
- Creates service accounts for each service
- Grants orchestrator service account `roles/run.invoker` on all agent services
- Configures service-to-service authentication

### 6. ENVIRONMENT VARIABLES (AUTOMATICALLY SET)

The deployment script automatically sets:
- Agent service URLs in orchestrator
- Orchestrator URL in frontend
- GCP_PROJECT_ID in all services
- SERVICE_URL in orchestrator

---

## üìã PRE-DEPLOYMENT CHECKLIST

Before running `make gcloud-deploy`, ensure:

- [ ] **Secret Manager secret `google-ai-api-key` is created**
- [ ] **Cloud Storage bucket `explainiq-diagrams` is created**
- [ ] **You have authenticated:** `gcloud auth login`
- [ ] **You have set the project:** `gcloud config set project PROJECT_ID`
- [ ] **You have application default credentials:** `gcloud auth application-default login`

---

## üöÄ DEPLOYMENT COMMAND

After completing the manual setup above:

```bash
make gcloud-deploy PROJECT_ID=your-project-id
```

Or if images are already built:

```bash
make gcloud-deploy-skip-build PROJECT_ID=your-project-id
```

---

## üîç VERIFICATION AFTER DEPLOYMENT

1. **Check services are running:**
   ```bash
   gcloud run services list --region=europe-west1
   ```

2. **Get service URLs:**
   ```bash
   make gcloud-urls PROJECT_ID=your-project-id
   ```

3. **Check logs:**
   ```bash
   make gcloud-logs PROJECT_ID=your-project-id
   ```

4. **Test the frontend:**
   - Open the frontend URL in your browser
   - Try creating an explanation

---

## ‚ö†Ô∏è COMMON ISSUES

### Secret Not Found
**Error:** `Secret [google-ai-api-key] not found`
**Solution:** Create the secret using the command in section 1 above.

### Bucket Not Found
**Error:** `Bucket [explainiq-diagrams] not found`
**Solution:** Create the bucket using the command in section 2 above.

### Permission Denied
**Error:** `Permission denied on secret`
**Solution:** Grant the Cloud Run service account access to the secret (see section 1).

---

## üìù NOTES

- The deployment script handles most setup automatically
- Only the Secret Manager secret and Cloud Storage bucket require manual creation
- All other configuration is handled by the deployment script
- Service-to-service authentication is configured automatically
- Environment variables are set automatically after deployment

